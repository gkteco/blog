<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="This notebook walks through the DataBlock API in fastai. It’s a core part of the fastai high level api workflow.">

<title>DataBlock Walkthrough – blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="DataBlock Walkthrough – blog">
<meta property="og:description" content="This notebook walks through the DataBlock API in fastai. It’s a core part of the fastai high level api workflow.">
<meta property="og:site_name" content="blog">
<meta name="twitter:title" content="DataBlock Walkthrough – blog">
<meta name="twitter:description" content="This notebook walks through the DataBlock API in fastai. It’s a core part of the fastai high level api workflow.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./datablock walkthrough.html">DataBlock Walkthrough</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gianni Crivello’s Blog</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datablock walkthrough.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">DataBlock Walkthrough</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lazy evaluation framework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Framework for Lazy Evaluation of Language Models</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-databock-api-introduction" id="toc-the-databock-api-introduction" class="nav-link active" data-scroll-target="#the-databock-api-introduction">The <code>DataBock</code> API Introduction</a>
  <ul class="collapse">
  <li><a href="#untar_data" id="toc-untar_data" class="nav-link" data-scroll-target="#untar_data">untar_data</a></li>
  <li><a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets">Datasets</a></li>
  </ul></li>
  <li><a href="#dataloaders" id="toc-dataloaders" class="nav-link" data-scroll-target="#dataloaders">Dataloaders</a></li>
  <li><a href="#mnist" id="toc-mnist" class="nav-link" data-scroll-target="#mnist">MNIST</a></li>
  <li><a href="#segmentation" id="toc-segmentation" class="nav-link" data-scroll-target="#segmentation">Segmentation</a></li>
  <li><a href="#points" id="toc-points" class="nav-link" data-scroll-target="#points">Points</a></li>
  <li><a href="#todo-walk-through-the-ulmfit-approach-to-training-a-language-model-building-up-the-dataloaders-with-the-datablock-api." id="toc-todo-walk-through-the-ulmfit-approach-to-training-a-language-model-building-up-the-dataloaders-with-the-datablock-api." class="nav-link" data-scroll-target="#todo-walk-through-the-ulmfit-approach-to-training-a-language-model-building-up-the-dataloaders-with-the-datablock-api.">TODO, walk through the ULMFit approach to training a language model, building up the dataloaders with the DataBlock API.</a></li>
  <li><a href="#todo-walk-through-the-tabular-data-example" id="toc-todo-walk-through-the-tabular-data-example" class="nav-link" data-scroll-target="#todo-walk-through-the-tabular-data-example">TODO, walk through the tabular data example</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/gkteco/blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DataBlock Walkthrough</h1>
</div>

<div>
  <div class="description">
    This notebook walks through the <code>DataBlock</code> API in fastai. It’s a core part of the fastai high level api workflow.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="the-databock-api-introduction" class="level1">
<h1>The <code>DataBock</code> API Introduction</h1>
<p>The <code>DataBlock</code> API from fastai is a powerful library for building custom data processing pipelines. It’s a core part of the fastai high level api workflow.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-2-1-image.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<p><strong>Quick note on fastai’s API Design</strong></p>
<p>Fastai’s API design philosophy emphasizes simplicity and flexibility. This is an approach that I really appreciate. When I evaluate a new library, It’s natural for me to build something simple to get a quick win, and iterativly build up to a more complex application. In my line of work, being able to scale down and prove out a concept is just as important as being able to scale up.</p>
<p>Key aspects of fastai’s API design that I think are important are:</p>
<ol type="1">
<li><p>Sensible defaults: Many functions come with pre-configured settings that work well for common use cases. You’ll see this in action with the <code>DataBlock</code> API. Having your ML framework choose sensible defaults based on a type system is something I really like.</p></li>
<li><p>Layered API: The library provides both high-level APIs for rapid development and low-level APIs for fine-grained control. This goes back to the idea of being able to prove a concept quickly without having to rewrite everything once you’re ready to scale. Fastai is built on top of PyTorch, so the deeper you go into the library, the more you’ll just be using PyTorch. Which is also great!</p></li>
<li><p>The library is very well documented, very hackable, and is easy to understand. This is a huge benefit for those of us that don’t have a large team and need to really be able to rely on the library’s documentation for more complex applications.</p></li>
</ol>
<p>Great, now let’s go DataBlock crazy!</p>
<p>Start by importing the modules we’ll need for this walkthrough.</p>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we are now going to download the pets dataset from URLs this returns a pathlib object</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet')</code></pre>
</div>
</div>
<p>If you’re ever curious about what you are working with in fastai, assuming you’re in a notebook, you can user the <code>??</code> command to get a quick overview of the object’s source code. You can also use <code>show_doc</code> to get a detailed description of the object’s API.</p>
<hr>
<p><a href="https://github.com/fastai/fastai/blob/master/fastai/data/external.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="untar_data" class="level3">
<h3 class="anchored" data-anchor-id="untar_data">untar_data</h3>
<blockquote class="blockquote">
<pre><code> untar_data (url:str, archive:pathlib.Path=None, data:pathlib.Path=None,
             c_key:str='data', force_download:bool=False,
             base:str='~/.fastai')</code></pre>
</blockquote>
<p><em>Download <code>url</code> using <code>FastDownload.get</code></em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>url</td>
<td>str</td>
<td></td>
<td>File to download</td>
</tr>
<tr class="even">
<td>archive</td>
<td>Path</td>
<td>None</td>
<td>Optional override for <code>Config</code>’s <code>archive</code> key</td>
</tr>
<tr class="odd">
<td>data</td>
<td>Path</td>
<td>None</td>
<td>Optional override for <code>Config</code>’s <code>data</code> key</td>
</tr>
<tr class="even">
<td>c_key</td>
<td>str</td>
<td>data</td>
<td>Key in <code>Config</code> where to extract file</td>
</tr>
<tr class="odd">
<td>force_download</td>
<td>bool</td>
<td>False</td>
<td>Setting to <code>True</code> will overwrite any existing copy of data</td>
</tr>
<tr class="even">
<td>base</td>
<td>str</td>
<td>~/.fastai</td>
<td>Directory containing config file and base of relative paths</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Path</strong></td>
<td></td>
<td><strong>Path to extracted file(s)</strong></td>
</tr>
</tbody>
</table>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here is the source code for `URLs`</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>URLs??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Init signature: URLs()
Source:        
class URLs():
    "Global constants for dataset and model URLs."
    LOCAL_PATH = Path.cwd()
    MDL = 'http://files.fast.ai/models/'
    GOOGLE = 'https://storage.googleapis.com/'
    S3  = 'https://s3.amazonaws.com/fast-ai-'
    URL = f'{S3}sample/'

    S3_IMAGE    = f'{S3}imageclas/'
    S3_IMAGELOC = f'{S3}imagelocal/'
    S3_AUDI     = f'{S3}audio/'
    S3_NLP      = f'{S3}nlp/'
    S3_COCO     = f'{S3}coco/'
    S3_MODEL    = f'{S3}modelzoo/'

    # main datasets
    ADULT_SAMPLE        = f'{URL}adult_sample.tgz'
    BIWI_SAMPLE         = f'{URL}biwi_sample.tgz'
    CIFAR               = f'{URL}cifar10.tgz'
    COCO_SAMPLE         = f'{S3_COCO}coco_sample.tgz'
    COCO_TINY           = f'{S3_COCO}coco_tiny.tgz'
    HUMAN_NUMBERS       = f'{URL}human_numbers.tgz'
    IMDB                = f'{S3_NLP}imdb.tgz'
    IMDB_SAMPLE         = f'{URL}imdb_sample.tgz'
    ML_SAMPLE           = f'{URL}movie_lens_sample.tgz'
    ML_100k             = 'https://files.grouplens.org/datasets/movielens/ml-100k.zip'
    MNIST_SAMPLE        = f'{URL}mnist_sample.tgz'
    MNIST_TINY          = f'{URL}mnist_tiny.tgz'
    MNIST_VAR_SIZE_TINY = f'{S3_IMAGE}mnist_var_size_tiny.tgz'
    PLANET_SAMPLE       = f'{URL}planet_sample.tgz'
    PLANET_TINY         = f'{URL}planet_tiny.tgz'
    IMAGENETTE          = f'{S3_IMAGE}imagenette2.tgz'
    IMAGENETTE_160      = f'{S3_IMAGE}imagenette2-160.tgz'
    IMAGENETTE_320      = f'{S3_IMAGE}imagenette2-320.tgz'
    IMAGEWOOF           = f'{S3_IMAGE}imagewoof2.tgz'
    IMAGEWOOF_160       = f'{S3_IMAGE}imagewoof2-160.tgz'
    IMAGEWOOF_320       = f'{S3_IMAGE}imagewoof2-320.tgz'
    IMAGEWANG           = f'{S3_IMAGE}imagewang.tgz'
    IMAGEWANG_160       = f'{S3_IMAGE}imagewang-160.tgz'
    IMAGEWANG_320       = f'{S3_IMAGE}imagewang-320.tgz'

    # kaggle competitions download dogs-vs-cats -p {DOGS.absolute()}
    DOGS = f'{URL}dogscats.tgz'

    # image classification datasets
    CALTECH_101  = f'{S3_IMAGE}caltech_101.tgz'
    CARS         = f'{S3_IMAGE}stanford-cars.tgz'
    CIFAR_100    = f'{S3_IMAGE}cifar100.tgz'
    CUB_200_2011 = f'{S3_IMAGE}CUB_200_2011.tgz'
    FLOWERS      = f'{S3_IMAGE}oxford-102-flowers.tgz'
    FOOD         = f'{S3_IMAGE}food-101.tgz'
    MNIST        = f'{S3_IMAGE}mnist_png.tgz'
    PETS         = f'{S3_IMAGE}oxford-iiit-pet.tgz'

    # NLP datasets
    AG_NEWS                 = f'{S3_NLP}ag_news_csv.tgz'
    AMAZON_REVIEWS          = f'{S3_NLP}amazon_review_full_csv.tgz'
    AMAZON_REVIEWS_POLARITY = f'{S3_NLP}amazon_review_polarity_csv.tgz'
    DBPEDIA                 = f'{S3_NLP}dbpedia_csv.tgz'
    MT_ENG_FRA              = f'{S3_NLP}giga-fren.tgz'
    SOGOU_NEWS              = f'{S3_NLP}sogou_news_csv.tgz'
    WIKITEXT                = f'{S3_NLP}wikitext-103.tgz'
    WIKITEXT_TINY           = f'{S3_NLP}wikitext-2.tgz'
    YAHOO_ANSWERS           = f'{S3_NLP}yahoo_answers_csv.tgz'
    YELP_REVIEWS            = f'{S3_NLP}yelp_review_full_csv.tgz'
    YELP_REVIEWS_POLARITY   = f'{S3_NLP}yelp_review_polarity_csv.tgz'

    # Image localization datasets
    BIWI_HEAD_POSE     = f"{S3_IMAGELOC}biwi_head_pose.tgz"
    CAMVID             = f'{S3_IMAGELOC}camvid.tgz'
    CAMVID_TINY        = f'{URL}camvid_tiny.tgz'
    LSUN_BEDROOMS      = f'{S3_IMAGE}bedroom.tgz'
    PASCAL_2007        = f'{S3_IMAGELOC}pascal_2007.tgz'
    PASCAL_2012        = f'{S3_IMAGELOC}pascal_2012.tgz'

    # Audio classification datasets
    MACAQUES           = f'{GOOGLE}ml-animal-sounds-datasets/macaques.zip'
    ZEBRA_FINCH        = f'{GOOGLE}ml-animal-sounds-datasets/zebra_finch.zip'

    # Medical Imaging datasets
    #SKIN_LESION        = f'{S3_IMAGELOC}skin_lesion.tgz'
    SIIM_SMALL         = f'{S3_IMAGELOC}siim_small.tgz'
    TCGA_SMALL         = f'{S3_IMAGELOC}tcga_small.tgz'

    #Pretrained models
    OPENAI_TRANSFORMER = f'{S3_MODEL}transformer.tgz'
    WT103_FWD          = f'{S3_MODEL}wt103-fwd.tgz'
    WT103_BWD          = f'{S3_MODEL}wt103-bwd.tgz'

    def path(
        url:str='.', # File to download
        c_key:str='archive' # Key in `Config` where to save URL
    ) -&gt; Path:
        "Local path where to download based on `c_key`"
        fname = url.split('/')[-1]
        local_path = URLs.LOCAL_PATH/('models' if c_key=='model' else 'data')/fname
        if local_path.exists(): return local_path
        return fastai_path(c_key)/fname
File:           ~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/external.py
Type:           type
Subclasses:     </code></pre>
</div>
</div>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's instantiate a `DataBlock` object</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># by itself, a `DataBlock` is just a blueprint for how to assemple your data. For us to do </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># anything, useful with it we need to pass in a source and what we want the dblock to return.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You get two options - A `Datasets` object or a `DataLoaders` object.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> dblock.datasets(get_image_files(path<span class="op">/</span><span class="st">"images"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will see our file repeated twice, that is because by default,</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the `DataBlock` API assumes we have an input and a target and will wrape it in a tuple.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>dsets.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/american_pit_bull_terrier_152.jpg'),
 Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/american_pit_bull_terrier_152.jpg'))</code></pre>
</div>
</div>
<p>If we look at the type…</p>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(dsets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>fastai.data.core.Datasets</code></pre>
</div>
</div>
<p>We just stamped out a <code>Datasets</code> object. Let’s dive a little deeper into what we just created.</p>
</section>
<section id="datasets" class="level2">
<h2 class="anchored" data-anchor-id="datasets">Datasets</h2>
<p>Datasets can be thought of as a object that returns a tuple from <code>items</code>, such as <code>(input, target)</code> and applies a <code>Pipeline</code> or <code>Transform</code> to each item in <code>items</code>.</p>
<p>Someting important to note is that for each transform in <code>tfms</code>, it creates an element in the tuple. So that means if you have two transforms, you’ll have a tuple of length 2, if you have three transforms, you’ll have a tuple of length 3, and so on. Let’s see an exmample.</p>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># items we are going to pass into `Datasets`</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># making a datasets object with no transforms will product a tuple of length 1</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># basicially, just the item in items wrapped in a tuple </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [1, 2, 3, 4] -&gt; [(1, ), (2, ), (3, ), (4, )]</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(items)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>dsets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#4) [(1,),(2,),(3,),(4,)]</code></pre>
</div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's see what happens when we add a list of transforms</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in this case, I'm giving the argument `tfms` a list of two identity functions</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll get back out a tuple of length 2 packing up our list into a list of tuples</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [1, 2, 3, 4] -&gt; [(1, 1), (2, 2), (3, 3), (4, 4)]</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(items, tfms<span class="op">=</span>[<span class="kw">lambda</span> i: i, <span class="kw">lambda</span> i: i])</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>dsets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#4) [(1, 1),(2, 2),(3, 3),(4, 4)]</code></pre>
</div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's get more creative and create a dataset where our dependent variable is the item</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in items and our dependent variable is a the result of the function f(x) = x**2</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1, 2, 3, 4] -&gt; [(1, 1), (2, 4), (3, 9), (4, 16)]</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(items, tfms<span class="op">=</span>[<span class="kw">lambda</span> i: i, <span class="kw">lambda</span> i: i<span class="op">**</span><span class="dv">2</span>])</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>dsets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#4) [(1, 1),(2, 4),(3, 9),(4, 16)]</code></pre>
</div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or let's build a dataset where we output a tuple of length 3</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(items, tfms<span class="op">=</span>[<span class="kw">lambda</span> i: i, <span class="kw">lambda</span> i: i<span class="op">**</span><span class="dv">2</span>, <span class="kw">lambda</span> i: i<span class="op">**</span><span class="dv">3</span>])</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>dsets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#4) [(1, 1, 1),(2, 4, 8),(3, 9, 27),(4, 16, 64)]</code></pre>
</div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's get even more creative! Let's say I had a list of transforms for the dependent variable</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and a list of transforms for the independent variable. Can we do this? Yes we can!</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(items, tfms<span class="op">=</span>[[<span class="kw">lambda</span> i: i<span class="op">**</span><span class="dv">2</span>, <span class="kw">lambda</span> i: i<span class="op">+</span><span class="dv">1</span>], [<span class="kw">lambda</span> i: i<span class="op">**</span><span class="dv">2</span>, <span class="kw">lambda</span> i: i<span class="op">+</span><span class="dv">2</span>]])</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>dsets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#4) [(2, 3),(5, 6),(10, 11),(17, 18)]</code></pre>
</div>
</div>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can also use a `Pipeline` object to chain our transforms together.</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([<span class="kw">lambda</span> i: i<span class="op">**</span><span class="dv">2</span>, <span class="kw">lambda</span> i: i<span class="op">+</span><span class="dv">1</span>])</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># now we have a pipeline that will take x and return x**2 + 1</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>test_eq(pipe(<span class="dv">2</span>), <span class="dv">5</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>test_eq(pipe(<span class="dv">3</span>), <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can use this pipeline to create a dataset.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(items, tfms<span class="op">=</span>[pipe, pipe])</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>dsets</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We can also use a `Transform` object to transform our data.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#4) [(2, 2),(5, 5),(10, 10),(17, 17)]</code></pre>
</div>
</div>
<p>What if we want to split our data into a training and validation set?</p>
<p>This is where we can tell <code>Datasets</code> to split our data into a training and validation set. I personally like to use python’s builtin <code>slice</code> function to do this. Slices in python are great, it’s a flexible way for us to tell <code>Datasets</code> which indices we want to start and stop for both our training and validation set.</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 1000 data points</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.array([np.random.randint(<span class="dv">0</span>, <span class="dv">10</span>, dtype<span class="op">=</span><span class="bu">int</span>) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>)]).reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># find the index of where we plan to split out data</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>split <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(data) <span class="op">*</span> <span class="fl">0.8</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># pass in our data, our transforms, and our split in the form of a list of slices</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>dset <span class="op">=</span> Datasets(data, </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>                tfms<span class="op">=</span>[<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>, <span class="kw">lambda</span> x: x<span class="op">+</span><span class="dv">1</span>],</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                splits<span class="op">=</span>[<span class="bu">slice</span>(<span class="dv">0</span>, split), <span class="bu">slice</span>(split, <span class="bu">len</span>(data))]</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's inspect our data now</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dset.train[<span class="dv">0</span>])</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dset.valid[<span class="dv">0</span>])</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" Lenght of train: </span><span class="sc">{</span><span class="bu">len</span>(dset.train)<span class="sc">}</span><span class="ss">, Length of valid: </span><span class="sc">{</span><span class="bu">len</span>(dset.valid)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(81, 10)
(16, 5)
 Lenght of train: 800, Length of valid: 200</code></pre>
</div>
</div>
<p>This wraps up my digression into <code>Datasets</code>. Knowing how they work can help us understand what <code>DataBlock</code> is doing for you when you call <code>DataBlock.datasets</code>. Knowing what <code>Datasets</code> is expecting is important (atleast for me) when i’m in data munging madness and need to debug complex data pipelines.</p>
<p>Let’s get back to <code>DataBlock</code>.</p>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember, `DataBlock` is just a blueprint on how to construct a `Datasets` or </span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># `DataLoaders` object. We can give `DataBlock` more information on how to stamp out</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># our data objects.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(get_items <span class="op">=</span> get_image_files)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we can pass a source to our call to `datasets` and we can get the same result as before</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> dblock.datasets(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>dsets[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/Egyptian_Mau_167.jpg'),
 Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/Egyptian_Mau_167.jpg'))</code></pre>
</div>
</div>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now that we know more information about `Datasets`, we can make our `DataBlock` more useful</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># our tuples (input, target) contain a repeating file path. Let's clean this up a little.</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> DataBlock(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> <span class="kw">lambda</span> x: x.name,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>).datasets(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Now our tuple should be the result of (filepath, label)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>dsets[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/Egyptian_Mau_167.jpg'),
 'Egyptian_Mau_167.jpg')</code></pre>
</div>
</div>
<p>We see that our label is the label of the file. For this we passed in a function to <code>get_y</code>. In the case of what we are going to use as an end-to-end example of using a <code>DataBlock</code> to train a model, we will need to create a function that will assign a label depending on a class that will be in our vocab.</p>
<p>So, for our example, let’s make a simple classification model, let’s predict whether or not a given image is a dog.</p>
<p>For this, our label will just be “cat” or “dog”.</p>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># our get y function</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(x):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"cat"</span> <span class="cf">if</span> x.name[<span class="dv">0</span>].isupper() <span class="cf">else</span> <span class="st">"dog"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    get_y     <span class="op">=</span> get_y,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> dblock.datasets(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>dsets.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(Path('/Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/basset_hound_199.jpg'),
 'dog')</code></pre>
</div>
</div>
<p>Nice. Now comes the interesting part of the <code>DataBlock</code> API and that is it’s type system.</p>
<p>I can tell <code>DataBlock</code> what type of data I’m working with and it will give me a good amount of reasonable defaults, all the way down to the loss function I should use. This is really cool for me, going back to what I said earlier about “scaling down”. Most of my work requires me to be fast, really fast. Having a solid foundation of what type of data I’m working with, then having fastai do a lot of the tedious work under the hood for me is something I find really cool.</p>
<p>Yes, sometimes I want to dig deep into a new loss function, or optimizer…..but most times, I just want something to work. Fastai is the best DSL i’ve come into use with.</p>
<p>Let’s see what I’m talking about.</p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I know that I want to predicit a label (cat or dog) from an image.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># So, I can tell `DataBlock` more information about my data by specifying blocks</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    blocks <span class="op">=</span> (ImageBlock, CategoryBlock), <span class="co"># this is what is new!</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> get_y,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># by specifying blocks, we are telling `DataBlock` that we are working with a tuple of </span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># (image, category). If we now stamp out a `Datasets` object, you'll see extra magic happen.</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> dblock.datasets(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>dsets[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(PILImage mode=RGB size=183x275, TensorCategory(0))</code></pre>
</div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's apply transformations to resize our images to a consistent size</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>get_y,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create datasets with the new DataBlock</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> dblock.datasets(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>ds[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(PILImage mode=RGB size=183x275, TensorCategory(0))</code></pre>
</div>
</div>
<p>That is interesting. Let’s inspect the data further by opening and displaying the image and looking up our label in the vocab.</p>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's open and display the image</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>img, label <span class="op">=</span> dsets[<span class="dv">0</span>]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>img.show()</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the label</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label: </span><span class="sc">{</span>dsets<span class="sc">.</span>vocab[label]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label: cat</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's now tell `DataBlock` how to split our data for training and validation.</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    blocks <span class="op">=</span> (ImageBlock, CategoryBlock),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> get_y,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    splitter <span class="op">=</span> RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>), <span class="co"># split 20% of data to validation</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># let's inspect our dblock with `summary`</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>dblock.summary(path<span class="op">/</span><span class="st">"images"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting-up type transforms pipelines
Collecting items from /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images
Found 7390 items
2 datasets of sizes 5912,1478
Setting up Pipeline: PILBase.create
Setting up Pipeline: get_y -&gt; Categorize -- {'vocab': None, 'sort': True, 'add_na': False}

Building one sample
  Pipeline: PILBase.create
    starting from
      /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/saint_bernard_60.jpg
    applying PILBase.create gives
      PILImage mode=RGB size=375x500
  Pipeline: get_y -&gt; Categorize -- {'vocab': None, 'sort': True, 'add_na': False}
    starting from
      /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/saint_bernard_60.jpg
    applying get_y gives
      dog
    applying Categorize -- {'vocab': None, 'sort': True, 'add_na': False} gives
      TensorCategory(1)

Final sample: (PILImage mode=RGB size=375x500, TensorCategory(1))


Collecting items from /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images
Found 7390 items
2 datasets of sizes 5912,1478
Setting up Pipeline: PILBase.create
Setting up Pipeline: get_y -&gt; Categorize -- {'vocab': None, 'sort': True, 'add_na': False}
Setting up after_item: Pipeline: ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}

Building one batch
Applying item_tfms to the first sample:
  Pipeline: ToTensor
    starting from
      (PILImage mode=RGB size=375x500, TensorCategory(1))
    applying ToTensor gives
      (TensorImage of size 3x500x375, TensorCategory(1))

Adding the next 3 samples

No before_batch transform to apply

Collating items in a batch
Error! It's not possible to collate your items in a batch
Could not collate the 0-th members of your tuples because got the following shapes
torch.Size([3, 500, 375]),torch.Size([3, 333, 500]),torch.Size([3, 352, 500]),torch.Size([3, 500, 354])</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[154], line 11</span>
<span class="ansi-green-fg ansi-bold">      3</span> dblock <span style="color:rgb(98,98,98)">=</span> DataBlock(
<span class="ansi-green-fg ansi-bold">      4</span>     blocks <span style="color:rgb(98,98,98)">=</span> (ImageBlock, CategoryBlock),
<span class="ansi-green-fg ansi-bold">      5</span>     get_items <span style="color:rgb(98,98,98)">=</span> get_image_files,
<span class="ansi-green-fg ansi-bold">      6</span>     get_y <span style="color:rgb(98,98,98)">=</span> get_y,
<span class="ansi-green-fg ansi-bold">      7</span>     splitter <span style="color:rgb(98,98,98)">=</span> RandomSplitter(valid_pct<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0.2</span>, seed<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">42</span>), <span style="font-style:italic;color:rgb(95,135,135)"># split 20% of data to validation</span>
<span class="ansi-green-fg ansi-bold">      8</span> )
<span class="ansi-green-fg ansi-bold">     10</span> <span style="font-style:italic;color:rgb(95,135,135)"># let's inspect our dblock with `summary`</span>
<span class="ansi-green-fg">---&gt; 11</span> <span class="ansi-yellow-bg">dblock</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">summary</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">/</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">images</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/block.py:237</span>, in <span class="ansi-cyan-fg">summary</span><span class="ansi-blue-fg">(self, source, bs, show_batch, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    235</span>     why <span style="color:rgb(98,98,98)">=</span> _find_fail_collate(s)
<span class="ansi-green-fg ansi-bold">    236</span>     <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Make sure all parts of your samples are tensors of the same size</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> why <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> why)
<span class="ansi-green-fg">--&gt; 237</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> e
<span class="ansi-green-fg ansi-bold">    239</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">len</span>([f <span style="font-weight:bold;color:rgb(0,135,0)">for</span> f <span style="font-weight:bold;color:rgb(175,0,255)">in</span> dls<span style="color:rgb(98,98,98)">.</span>train<span style="color:rgb(98,98,98)">.</span>after_batch<span style="color:rgb(98,98,98)">.</span>fs <span style="font-weight:bold;color:rgb(0,135,0)">if</span> f<span style="color:rgb(98,98,98)">.</span>name <span style="color:rgb(98,98,98)">!=</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">noop</span><span style="color:rgb(175,0,0)">'</span>])<span style="color:rgb(98,98,98)">!=</span><span style="color:rgb(98,98,98)">0</span>:
<span class="ansi-green-fg ansi-bold">    240</span>     <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="color:rgb(175,0,0)">Applying batch_tfms to the batch built</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/block.py:231</span>, in <span class="ansi-cyan-fg">summary</span><span class="ansi-blue-fg">(self, source, bs, show_batch, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    229</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="color:rgb(175,0,0)">Collating items in a batch</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    230</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 231</span>     b <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">dls</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">train</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">create_batch</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">s</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    232</span>     b <span style="color:rgb(98,98,98)">=</span> retain_types(b, s[<span style="color:rgb(98,98,98)">0</span>] <span style="font-weight:bold;color:rgb(0,135,0)">if</span> is_listy(s) <span style="font-weight:bold;color:rgb(0,135,0)">else</span> s)
<span class="ansi-green-fg ansi-bold">    233</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/load.py:181</span>, in <span class="ansi-cyan-fg">DataLoader.create_batch</span><span class="ansi-blue-fg">(self, b)</span>
<span class="ansi-green-fg ansi-bold">    179</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>: <span style="font-weight:bold;color:rgb(0,135,0)">return</span> (fa_collate,fa_convert)[<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>prebatched](b)
<span class="ansi-green-fg ansi-bold">    180</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e: 
<span class="ansi-green-fg">--&gt; 181</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>prebatched: <span class="ansi-yellow-bg">collate_error</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">e</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg">b</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/load.py:179</span>, in <span class="ansi-cyan-fg">DataLoader.create_batch</span><span class="ansi-blue-fg">(self, b)</span>
<span class="ansi-green-fg ansi-bold">    178</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">create_batch</span>(<span style="color:rgb(0,135,0)">self</span>, b): 
<span class="ansi-green-fg">--&gt; 179</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>: <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">fa_collate</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg">fa_convert</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">prebatched</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">b</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e: 
<span class="ansi-green-fg ansi-bold">    181</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>prebatched: collate_error(e,b)

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/load.py:52</span>, in <span class="ansi-cyan-fg">fa_collate</span><span class="ansi-blue-fg">(t)</span>
<span class="ansi-green-fg ansi-bold">     49</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">A replacement for PyTorch `default_collate` which maintains types and handles `Sequence`s</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     50</span> b <span style="color:rgb(98,98,98)">=</span> t[<span style="color:rgb(98,98,98)">0</span>]
<span class="ansi-green-fg ansi-bold">     51</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> (default_collate(t) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(b, _collate_types)
<span class="ansi-green-fg">---&gt; 52</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(0,135,0)">type</span>(t[<span style="color:rgb(98,98,98)">0</span>])([fa_collate(s) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> s <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(<span style="color:rgb(98,98,98)">*</span>t)]) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(b, Sequence)
<span class="ansi-green-fg ansi-bold">     53</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> default_collate(t))

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/load.py:52</span>, in <span class="ansi-cyan-fg">&lt;listcomp&gt;</span><span class="ansi-blue-fg">(.0)</span>
<span class="ansi-green-fg ansi-bold">     49</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">A replacement for PyTorch `default_collate` which maintains types and handles `Sequence`s</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     50</span> b <span style="color:rgb(98,98,98)">=</span> t[<span style="color:rgb(98,98,98)">0</span>]
<span class="ansi-green-fg ansi-bold">     51</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> (default_collate(t) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(b, _collate_types)
<span class="ansi-green-fg">---&gt; 52</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(0,135,0)">type</span>(t[<span style="color:rgb(98,98,98)">0</span>])([<span class="ansi-yellow-bg">fa_collate</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">s</span><span class="ansi-yellow-bg">)</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> s <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(<span style="color:rgb(98,98,98)">*</span>t)]) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(b, Sequence)
<span class="ansi-green-fg ansi-bold">     53</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> default_collate(t))

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/load.py:51</span>, in <span class="ansi-cyan-fg">fa_collate</span><span class="ansi-blue-fg">(t)</span>
<span class="ansi-green-fg ansi-bold">     49</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">A replacement for PyTorch `default_collate` which maintains types and handles `Sequence`s</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     50</span> b <span style="color:rgb(98,98,98)">=</span> t[<span style="color:rgb(98,98,98)">0</span>]
<span class="ansi-green-fg">---&gt; 51</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> (<span class="ansi-yellow-bg">default_collate</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">t</span><span class="ansi-yellow-bg">)</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(b, _collate_types)
<span class="ansi-green-fg ansi-bold">     52</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(0,135,0)">type</span>(t[<span style="color:rgb(98,98,98)">0</span>])([fa_collate(s) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> s <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(<span style="color:rgb(98,98,98)">*</span>t)]) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(b, Sequence)
<span class="ansi-green-fg ansi-bold">     53</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> default_collate(t))

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/torch/utils/data/_utils/collate.py:317</span>, in <span class="ansi-cyan-fg">default_collate</span><span class="ansi-blue-fg">(batch)</span>
<span class="ansi-green-fg ansi-bold">    256</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">default_collate</span>(batch):
<span class="ansi-green-fg ansi-bold">    257</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    258</span> <span style="font-style:italic;color:rgb(175,0,0)">    Take in a batch of data and put the elements within the batch into a tensor with an additional outer dimension - batch size.</span>
<span class="ansi-green-fg ansi-bold">    259</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    315</span> <span style="font-style:italic;color:rgb(175,0,0)">        &gt;&gt;&gt; default_collate(batch)  # Handle `CustomType` automatically</span>
<span class="ansi-green-fg ansi-bold">    316</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 317</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">collate</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">collate_fn_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">default_collate_fn_map</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/torch/utils/data/_utils/collate.py:146</span>, in <span class="ansi-cyan-fg">collate</span><span class="ansi-blue-fg">(batch, collate_fn_map)</span>
<span class="ansi-green-fg ansi-bold">    144</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> collate_type <span style="font-weight:bold;color:rgb(175,0,255)">in</span> collate_fn_map:
<span class="ansi-green-fg ansi-bold">    145</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(elem, collate_type):
<span class="ansi-green-fg">--&gt; 146</span>             <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">collate_fn_map</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">collate_type</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">collate_fn_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">collate_fn_map</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    148</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(elem, collections<span style="color:rgb(98,98,98)">.</span>abc<span style="color:rgb(98,98,98)">.</span>Mapping):
<span class="ansi-green-fg ansi-bold">    149</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/torch/utils/data/_utils/collate.py:214</span>, in <span class="ansi-cyan-fg">collate_tensor_fn</span><span class="ansi-blue-fg">(batch, collate_fn_map)</span>
<span class="ansi-green-fg ansi-bold">    212</span>     storage <span style="color:rgb(98,98,98)">=</span> elem<span style="color:rgb(98,98,98)">.</span>_typed_storage()<span style="color:rgb(98,98,98)">.</span>_new_shared(numel, device<span style="color:rgb(98,98,98)">=</span>elem<span style="color:rgb(98,98,98)">.</span>device)
<span class="ansi-green-fg ansi-bold">    213</span>     out <span style="color:rgb(98,98,98)">=</span> elem<span style="color:rgb(98,98,98)">.</span>new(storage)<span style="color:rgb(98,98,98)">.</span>resize_(<span style="color:rgb(0,135,0)">len</span>(batch), <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">list</span>(elem<span style="color:rgb(98,98,98)">.</span>size()))
<span class="ansi-green-fg">--&gt; 214</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">stack</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">0</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">out</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">out</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/torch_core.py:382</span>, in <span class="ansi-cyan-fg">TensorBase.__torch_function__</span><span class="ansi-blue-fg">(cls, func, types, args, kwargs)</span>
<span class="ansi-green-fg ansi-bold">    380</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">cls</span><span style="color:rgb(98,98,98)">.</span>debug <span style="font-weight:bold;color:rgb(175,0,255)">and</span> func<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> (<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">__str__</span><span style="color:rgb(175,0,0)">'</span>,<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">__repr__</span><span style="color:rgb(175,0,0)">'</span>): <span style="color:rgb(0,135,0)">print</span>(func, types, args, kwargs)
<span class="ansi-green-fg ansi-bold">    381</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> _torch_handled(args, <span style="color:rgb(0,135,0)">cls</span><span style="color:rgb(98,98,98)">.</span>_opt, func): types <span style="color:rgb(98,98,98)">=</span> (torch<span style="color:rgb(98,98,98)">.</span>Tensor,)
<span class="ansi-green-fg">--&gt; 382</span> res <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">super</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">__torch_function__</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">types</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ifnone</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">{</span><span class="ansi-yellow-bg">}</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    383</span> dict_objs <span style="color:rgb(98,98,98)">=</span> _find_args(args) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> args <span style="font-weight:bold;color:rgb(0,135,0)">else</span> _find_args(<span style="color:rgb(0,135,0)">list</span>(kwargs<span style="color:rgb(98,98,98)">.</span>values()))
<span class="ansi-green-fg ansi-bold">    384</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">issubclass</span>(<span style="color:rgb(0,135,0)">type</span>(res),TensorBase) <span style="font-weight:bold;color:rgb(175,0,255)">and</span> dict_objs: res<span style="color:rgb(98,98,98)">.</span>set_meta(dict_objs[<span style="color:rgb(98,98,98)">0</span>],as_copy<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>)

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.10/site-packages/torch/_tensor.py:1437</span>, in <span class="ansi-cyan-fg">Tensor.__torch_function__</span><span class="ansi-blue-fg">(cls, func, types, args, kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1434</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">NotImplemented</span>
<span class="ansi-green-fg ansi-bold">   1436</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> _C<span style="color:rgb(98,98,98)">.</span>DisableTorchFunctionSubclass():
<span class="ansi-green-fg">-&gt; 1437</span>     ret <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1438</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> func <span style="font-weight:bold;color:rgb(175,0,255)">in</span> get_default_nowrap_functions():
<span class="ansi-green-fg ansi-bold">   1439</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> ret

<span class="ansi-red-fg">RuntimeError</span>: Error when trying to collate the data into batches with fa_collate, at least two tensors in the batch are not the same size.

Mismatch found on axis 0 of the batch and is of type `TensorImage`:
    Item at index 0 has shape: torch.Size([3, 500, 375])
    Item at index 1 has shape: torch.Size([3, 333, 500])

Please include a transform in `after_item` that ensures all data of type TensorImage is the same size</pre>
</div>
</div>
</div>
<p>Opps! We have an error. If we follow the trace that <code>summary</code> gives us, we can see that we are able to build up a single example of our data easily (which means we can bulid up a <code>Datasets</code> object). However, we break when we attempt to collate our data into batches.</p>
<p>Why is that? Well, our <code>summary</code> tels us:</p>
<pre><code>Mismatch found on axis 0 of the batch and is of type `TensorImage`:
    Item at index 0 has shape: torch.Size([3, 500, 375])
    Item at index 1 has shape: torch.Size([3, 333, 500])</code></pre>
<p>Our images are of different sizes! <code>DataBlock</code> gives us a method to change this. We can pass in a transform to <code>item_tfms</code> to apply a transform to our independent variables. This should fix the issue.</p>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    blocks <span class="op">=</span> (ImageBlock, CategoryBlock),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> get_y,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    splitter <span class="op">=</span> RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    item_tfms <span class="op">=</span> Resize(<span class="dv">224</span>), <span class="co"># resize each image to 224x224</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>dblock.summary(path<span class="op">/</span><span class="st">"images"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting-up type transforms pipelines
Collecting items from /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images
Found 7390 items
2 datasets of sizes 5912,1478
Setting up Pipeline: PILBase.create
Setting up Pipeline: get_y -&gt; Categorize -- {'vocab': None, 'sort': True, 'add_na': False}

Building one sample
  Pipeline: PILBase.create
    starting from
      /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/saint_bernard_60.jpg
    applying PILBase.create gives
      PILImage mode=RGB size=375x500
  Pipeline: get_y -&gt; Categorize -- {'vocab': None, 'sort': True, 'add_na': False}
    starting from
      /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images/saint_bernard_60.jpg
    applying get_y gives
      dog
    applying Categorize -- {'vocab': None, 'sort': True, 'add_na': False} gives
      TensorCategory(1)

Final sample: (PILImage mode=RGB size=375x500, TensorCategory(1))


Collecting items from /Users/giannicrivello/.fastai/data/oxford-iiit-pet/images
Found 7390 items
2 datasets of sizes 5912,1478
Setting up Pipeline: PILBase.create
Setting up Pipeline: get_y -&gt; Categorize -- {'vocab': None, 'sort': True, 'add_na': False}
Setting up after_item: Pipeline: Resize -- {'size': (224, 224), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0} -&gt; ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}

Building one batch
Applying item_tfms to the first sample:
  Pipeline: Resize -- {'size': (224, 224), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0} -&gt; ToTensor
    starting from
      (PILImage mode=RGB size=375x500, TensorCategory(1))
    applying Resize -- {'size': (224, 224), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0} gives
      (PILImage mode=RGB size=224x224, TensorCategory(1))
    applying ToTensor gives
      (TensorImage of size 3x224x224, TensorCategory(1))

Adding the next 3 samples

No before_batch transform to apply

Collating items in a batch

Applying batch_tfms to the batch built
  Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}
    starting from
      (TensorImage of size 4x3x224x224, TensorCategory([1, 0, 1, 1], device='mps:0'))
    applying IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} gives
      (TensorImage of size 4x3x224x224, TensorCategory([1, 0, 1, 1], device='mps:0'))</code></pre>
</div>
</div>
<p>Awesome. Now we are ready to stamp out our <code>Dataloaders</code> object and train a model. But first, let’s take a quick digresstion to talk about <code>Dataloaders</code>.</p>
</section>
</section>
<section id="dataloaders" class="level1">
<h1>Dataloaders</h1>
<p>When training a model, you generally want to collate your data into batches and move it to a GPU (or some other accelerator). <code>DataLoaders</code> let’s you do this.</p>
<p><code>DataLoaders</code> is a wrapper around <code>DataLoader</code> that provides a few extra features. Let’s first understand what a <code>DataLoader</code> is. A <code>DataLoader</code> can be pretty simple, you give it a <code>Dataset</code> and a <code>bs</code> (batch size) and it will return to you a generator of batches.</p>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a datasets object using get_image_files</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">'/Users/giannicrivello/.fastai/data/oxford-iiit-pet'</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'images'</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co"># user what we learned before form `Datasets`, I can create a dataset by passing in </span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># how I want my data to be transformed, in this case:</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># PILImage.create | resize | ToTensor</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>dset <span class="op">=</span> Datasets(files, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                tfms<span class="op">=</span>[</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                    [PILImage.create, Resize(<span class="dv">224</span>), ToTensor], </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                    [<span class="kw">lambda</span> x: <span class="dv">0</span> <span class="cf">if</span> x.name[<span class="dv">0</span>].isupper() <span class="cf">else</span> <span class="dv">1</span>]</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>                ])</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataloader object passing in our dataset and batch size</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>loader <span class="op">=</span> DataLoader(dset, bs<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co"># let's get a batch of data</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> first(loader)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>x.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([32, 3, 224, 224]), torch.Size([32]))</code></pre>
</div>
</div>
<p>Nice, now <code>DataLoaders</code> are just a wrapper around multiple <code>DataLoader</code>s.</p>
<p>Let’s see this by taking our loader and passing it to a <code>DataLoaders</code> object.</p>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's wrape our loaders in a `DataLoaders` object</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(loader, loader)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's get a batch from our train and valid loaders</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>x_train, y_train <span class="op">=</span> dls.train.one_batch()</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>x_valid, y_valid<span class="op">=</span> dls.valid.one_batch()</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape, y_train.shape)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_valid.shape, y_valid.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([32, 3, 224, 224]) torch.Size([32])
torch.Size([32, 3, 224, 224]) torch.Size([32])</code></pre>
</div>
</div>
<p>Generally, you can think of a <code>Datasets</code> object as a way to collect a tuple of independent and dependent variables from a datasource and apply transformations. A <code>DataLoader</code> object is a way for us to collate our data into batches, and move our data to a GPU.</p>
<p>Now we’re ready to finally use our <code>DataBlock</code> to create a <code>DataLoaders</code> object that can be batched, moved to a GPU, and used for training a classification model.</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once again, here is our `DataBlock` </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    blocks    <span class="op">=</span> (ImageBlock, CategoryBlock),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    get_y     <span class="op">=</span> get_y,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    splitter  <span class="op">=</span> RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    item_tfms <span class="op">=</span> RandomResizedCrop(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's now stamp out a `DataLoaders` object</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all looks good, let's just make sure we can grab a batch from our `DataLoaders` object</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and that everything is working as expected.</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> dls.train.one_batch()</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>x.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([64, 3, 224, 224]), torch.Size([64]))</code></pre>
</div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's now train a model and capture how long it takes</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>accuracy)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1 μs, sys: 1e+03 ns, total: 2 μs
Wall time: 3.1 μs</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.966686</td>
<td>0.359588</td>
<td>0.851150</td>
<td>01:28</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And there it is! We’ve just trained a model for one epoch on our data that reaches 85% accuracy. We did this by simply passing our <code>dls</code> into a <code>vision_learner</code>. I’m not going to got into depth on the details of the <code>vision_leaner</code>, I’ll leave that for another post. That being said, our <code>DataBlock</code> does alot of the heavy lifting for us. Let’s inspect a little…</p>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's look at some of the defaults our `DataBlock` chose for us.</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># One of the most important things our `DataBlock` did was choose a loss function for us.</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loss Function: </span><span class="sc">{</span>dls<span class="sc">.</span>loss_func<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss Function: FlattenedLoss of CrossEntropyLoss()</code></pre>
</div>
</div>
<p>But how did it know to choose cross entropy loss? Well, that’s because we told our <code>DataBlock</code> that we were working with Image data and that our target was a category. We did this by passing in this line of code:</p>
<pre><code>blocks = (ImageBlock, CategoryBlock)</code></pre>
<p>Fastai’s high level API is a nice paradigm to think about deep learning problems as defined by the <em>type</em> data we are working with as our independant variable and the <em>type</em> of target we are trying to predict.</p>
<p>I enjoy this approach because it allows a user to think about the problem more abstractly, without worrying aobut the specifics of the model.</p>
<p>For someone that just want to solve a problem, quick and dirty, this is a huge benefit.</p>
<p>Let’s now rinse and repeat with different <em>types</em> of data.</p>
</section>
<section id="mnist" class="level1">
<h1>MNIST</h1>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>mnist_dblock  <span class="op">=</span> DataBlock(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    blocks    <span class="op">=</span> (ImageBlock(cls<span class="op">=</span>PILImage), CategoryBlock),</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    get_y     <span class="op">=</span> <span class="kw">lambda</span> x: x.parent.name, <span class="co"># the name of the class will be the parent directory</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    splitter  <span class="op">=</span> GrandparentSplitter(),   <span class="co"># We are going to use the grandparent splitter to split our data</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> mnist_dblock.dataloaders(untar_data(URLs.MNIST_TINY))</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>dls.show_batch(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s train another model.</p>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>mnist_learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>mnist_learn.fit_one_cycle(<span class="dv">3</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.794717</td>
<td>5.435191</td>
<td>0.414878</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.755198</td>
<td>1.027816</td>
<td>0.882690</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.553269</td>
<td>0.779254</td>
<td>0.931330</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This time, let's use our trained model to predict on a data point</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> dls.valid.one_batch()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"label: </span><span class="sc">{</span>dls<span class="sc">.</span>vocab[y[<span class="dv">0</span>]]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span>].show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers). Got range [-2.117904..2.64].</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>label: 7</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-33-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's see what our model predicts</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>decoded, _ , preds <span class="op">=</span>  mnist_learn.predict(x[<span class="dv">0</span>].cpu())</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predictions: </span><span class="sc">{</span>preds<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label: </span><span class="sc">{</span>decoded<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Predictions: tensor([0.0013, 0.9987])
Label: 7</code></pre>
</div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's do another example of classification</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>pets_dblock    <span class="op">=</span> DataBlock(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    blocks     <span class="op">=</span> (ImageBlock, CategoryBlock),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    splitter   <span class="op">=</span> RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    get_items  <span class="op">=</span> get_image_files,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    get_y      <span class="op">=</span> Pipeline([</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>                attrgetter(<span class="st">"name"</span>), RegexLabeller(pat <span class="op">=</span> <span class="vs">r'^(.*)_\d+.jpg$'</span>)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>                ]),</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    item_tfms  <span class="op">=</span> Resize(<span class="dv">128</span>),</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    batch_tfms <span class="op">=</span> aug_transforms(size<span class="op">=</span><span class="dv">128</span>)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just as a note, attrgetter is just a function that will get an attribute from a passed argument. Here is a quick example of what it does.</p>
<div id="cell-57" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> NamedTuple</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyObj(NamedTuple):</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    a: <span class="bu">str</span> </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>my_obj <span class="op">=</span> MyObj(<span class="st">"Get this attribute"</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>my_obj</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>MyObj(a='Get this attribute')</code></pre>
</div>
</div>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now, here is my attrgetter</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>attrgetter(<span class="st">"a"</span>)(my_obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'Get this attribute'</code></pre>
</div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, once again, let's stamp out a `DataLoaders` object</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>pets_dls <span class="op">=</span> pets_dblock.dataloaders(untar_data(URLs.PETS)<span class="op">/</span> <span class="st">"images"</span>).cpu()</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>pets_dls.show_batch(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's look at the vocab</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>pets_dls.vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['Abyssinian', 'Bengal', 'Birman', 'Bombay', 'British_Shorthair', 'Egyptian_Mau', 'Maine_Coon', 'Persian', 'Ragdoll', 'Russian_Blue', 'Siamese', 'Sphynx', 'american_bulldog', 'american_pit_bull_terrier', 'basset_hound', 'beagle', 'boxer', 'chihuahua', 'english_cocker_spaniel', 'english_setter', 'german_shorthaired', 'great_pyrenees', 'havanese', 'japanese_chin', 'keeshond', 'leonberger', 'miniature_pinscher', 'newfoundland', 'pomeranian', 'pug', 'saint_bernard', 'samoyed', 'scottish_terrier', 'shiba_inu', 'staffordshire_bull_terrier', 'wheaten_terrier', 'yorkshire_terrier']</code></pre>
</div>
</div>
<div id="cell-61" class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's now train a model</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>pets_learn <span class="op">=</span> vision_learner(pets_dls.cpu(), resnet34, metrics<span class="op">=</span>accuracy)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>pets_learn.model.cpu()</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>pets_learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.461012</td>
<td>3.290012</td>
<td>0.106901</td>
<td>03:51</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s now see something a little different. Let’s now stamp our a <code>DataLoaders</code> object using a pandas DataFrame. To do this, we’ll use the PASCAL dataset.</p>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>pascal_source <span class="op">=</span> untar_data(URLs.PASCAL_2007)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>pascal_df <span class="op">=</span> pd.read_csv(pascal_source<span class="op">/</span><span class="st">"train.csv"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>pascal_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>000005.jpg</td>
<td>chair</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>000007.jpg</td>
<td>car</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>000009.jpg</td>
<td>horse person</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>000012.jpg</td>
<td>car</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>000016.jpg</td>
<td>bicycle</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This will be a multi-label classification problem. There are a few things to note here.</p>
<ol type="1">
<li>The path to the image is given by the <code>fname</code> column</li>
<li>The lables are given by the <code>labels</code> column and there are more than one label sperated by a space</li>
<li>We can parse the <code>is_valid</code> column to get us our split between train and validation</li>
</ol>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pascal_dblock <span class="op">=</span> DataBlock(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    blocks    <span class="op">=</span> (ImageBlock, MultiCategoryBlock),</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    get_x     <span class="op">=</span> ColReader(<span class="dv">0</span>, pref<span class="op">=</span>pascal_source<span class="op">/</span><span class="st">"train"</span>),</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    get_y     <span class="op">=</span> ColReader(<span class="dv">1</span>, label_delim<span class="op">=</span><span class="st">" "</span>),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    item_tfms <span class="op">=</span> RandomResizedCrop(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    splitter  <span class="op">=</span> ColSplitter(<span class="dv">2</span>),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms <span class="op">=</span> aug_transforms(size<span class="op">=</span><span class="dv">224</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>pascal_dls <span class="op">=</span> pascal_dblock.dataloaders(pascal_df, device<span class="op">=</span><span class="st">"cpu"</span>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>pascal_dls.show_batch(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/giannicrivello/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/transforms.py:212: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  o = r[c] if isinstance(c, int) or not c in getattr(r, '_fields', []) else getattr(r, c)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-42-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><code>DataBlock</code> is flexible enough to work with different types of data sources. In this case, we are telling the <code>DataBlock</code> how to use a pandas DataFrame to create our <code>DataLoader</code>. Then we just stamp one out!</p>
<p>Now that we are using a <code>MultiCategoryBlock</code>, let’s see the loss function our <code>DataBlock</code> chose for us.</p>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>pascal_dls.loss_func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>FlattenedLoss of BCEWithLogitsLoss()</code></pre>
</div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and let's train a model</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>pascal_learn <span class="op">=</span> vision_learner(pascal_dls.cpu(), resnet34)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>pascal_learn.model.cpu()</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>pascal_learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.459487</td>
<td>0.266029</td>
<td>05:15</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Another really cool use case of the flexability of the <code>DataBlock</code> API is more complex vision data such as Image Localization.</p>
</section>
<section id="segmentation" class="level1">
<h1>Segmentation</h1>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.CAMVID_TINY)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#3) [Path('/Users/giannicrivello/.fastai/data/camvid_tiny/images'),Path('/Users/giannicrivello/.fastai/data/camvid_tiny/labels'),Path('/Users/giannicrivello/.fastai/data/camvid_tiny/codes.txt')]</code></pre>
</div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>camvid_dblock <span class="op">=</span> DataBlock(</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    blocks    <span class="op">=</span> (ImageBlock, MaskBlock(codes <span class="op">=</span> np.loadtxt(path<span class="op">/</span><span class="st">"codes.txt"</span>, dtype<span class="op">=</span><span class="bu">str</span>))),</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    splitter  <span class="op">=</span> RandomSplitter(),</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    get_y     <span class="op">=</span> <span class="kw">lambda</span> o: path<span class="op">/</span><span class="st">'labels'</span><span class="op">/</span><span class="ss">f'</span><span class="sc">{</span>o<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">_P</span><span class="sc">{</span>o<span class="sc">.</span>suffix<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    batch_tfms <span class="op">=</span> aug_transforms()</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>camvid_dls <span class="op">=</span> camvid_dblock.dataloaders((path<span class="op">/</span><span class="st">'images'</span>), bs<span class="op">=</span><span class="dv">32</span>, device<span class="op">=</span><span class="st">"cpu"</span>)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>camvid_dls.show_batch(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="points" class="level1">
<h1>Points</h1>
<div id="cell-74" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>biwi_source <span class="op">=</span> untar_data(URLs.BIWI_SAMPLE)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>fn2ctr <span class="op">=</span> load_pickle(biwi_source<span class="op">/</span><span class="st">'centers.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="598016" class="" max="593774" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.71% [598016/593774 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/giannicrivello/miniconda3/envs/dev/lib/python3.10/site-packages/torch/storage.py:414: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  return torch.load(io.BytesIO(b))</code></pre>
</div>
</div>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>biwi <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, PointBlock),</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>                 get_items<span class="op">=</span>get_image_files,</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>                 splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>                 get_y<span class="op">=</span><span class="kw">lambda</span> o:fn2ctr[o.name].flip(<span class="dv">0</span>),</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>                 batch_tfms<span class="op">=</span>aug_transforms())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> biwi.dataloaders(biwi_source, bs<span class="op">=</span><span class="dv">32</span>, device<span class="op">=</span><span class="st">"cpu"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>coco_source <span class="op">=</span> untar_data(URLs.COCO_TINY)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>images, lbl_bbox <span class="op">=</span> get_annotations(coco_source<span class="op">/</span><span class="st">'train.json'</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>img2bbox <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(images, lbl_bbox))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="802816" class="" max="801038" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.22% [802816/801038 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>coco <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, BBoxBlock, BBoxLblBlock),</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>                 get_items<span class="op">=</span>get_image_files,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>                 splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>                 get_y<span class="op">=</span>[<span class="kw">lambda</span> o: img2bbox[o.name][<span class="dv">0</span>], <span class="kw">lambda</span> o: img2bbox[o.name][<span class="dv">1</span>]], </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>                 item_tfms<span class="op">=</span>Resize(<span class="dv">128</span>),</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>                 batch_tfms<span class="op">=</span>aug_transforms(),</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                 n_inp<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-79" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> coco.dataloaders(coco_source, bs<span class="op">=</span><span class="dv">32</span>, device<span class="op">=</span><span class="st">"cpu"</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_DataBlock Walkthrough_files/figure-html/cell-52-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This was all primarily vision tasks up to this point. Now let’s flex the flexibility of the <code>DataBlock</code> API to create <code>DataLoaders</code> for language tasks.</p>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.IMDB_SAMPLE)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>imdb_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">"texts.csv"</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>imdb_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="573440" class="" max="571827" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.28% [573440/571827 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>negative</td>
<td>Un-bleeping-believable! Meg Ryan doesn't even look her usual pert lovable self in this, which normally makes me forgive her shallow ticky acting schtick. Hard to believe she was the producer on this dog. Plus Kevin Kline: what kind of suicide trip has his career been on? Whoosh... Banzai!!! Finally this was directed by the guy who did Big Chill? Must be a replay of Jonestown - hollywood style. Wooofff!</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>positive</td>
<td>This is a extremely well-made film. The acting, script and camera-work are all first-rate. The music is good, too, though it is mostly early in the film, when things are still relatively cheery. There are no really superstars in the cast, though several faces will be familiar. The entire cast does an excellent job with the script.&lt;br /&gt;&lt;br /&gt;But it is hard to watch, because there is no good end to a situation like the one presented. It is now fashionable to blame the British for setting Hindus and Muslims against each other, and then cruelly separating them into two countries. There is som...</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>negative</td>
<td>Every once in a long while a movie will come along that will be so awful that I feel compelled to warn people. If I labor all my days and I can save but one soul from watching this movie, how great will be my joy.&lt;br /&gt;&lt;br /&gt;Where to begin my discussion of pain. For starters, there was a musical montage every five minutes. There was no character development. Every character was a stereotype. We had swearing guy, fat guy who eats donuts, goofy foreign guy, etc. The script felt as if it were being written as the movie was being shot. The production value was so incredibly low that it felt li...</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>positive</td>
<td>Name just says it all. I watched this movie with my dad when it came out and having served in Korea he had great admiration for the man. The disappointing thing about this film is that it only concentrate on a short period of the man's life - interestingly enough the man's entire life would have made such an epic bio-pic that it is staggering to imagine the cost for production.&lt;br /&gt;&lt;br /&gt;Some posters elude to the flawed characteristics about the man, which are cheap shots. The theme of the movie "Duty, Honor, Country" are not just mere words blathered from the lips of a high-brassed offic...</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>negative</td>
<td>This movie succeeds at being one of the most unique movies you've seen. However this comes from the fact that you can't make heads or tails of this mess. It almost seems as a series of challenges set up to determine whether or not you are willing to walk out of the movie and give up the money you just paid. If you don't want to feel slighted you'll sit through this horrible film and develop a real sense of pity for the actors involved, they've all seen better days, but then you realize they actually got paid quite a bit of money to do this and you'll lose pity for them just like you've alr...</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>imdb_dblock <span class="op">=</span> DataBlock(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    blocks <span class="op">=</span> TextBlock.from_df(<span class="st">"text"</span>, is_lm<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>              get_x <span class="op">=</span> ColReader(<span class="dv">2</span>),</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>              splitter <span class="op">=</span> ColSplitter(),</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>imdb_dls <span class="op">=</span> imdb_dblock.dataloaders(imdb_df, bs<span class="op">=</span><span class="dv">32</span>, seq_len<span class="op">=</span><span class="dv">72</span>, device<span class="op">=</span><span class="st">"cpu"</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>imdb_dls.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/giannicrivello/miniconda3/envs/dev/lib/python3.10/site-packages/fastai/data/transforms.py:212: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  o = r[c] if isinstance(c, int) or not c in getattr(r, '_fields', []) else getattr(r, c)</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">text_</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>xxbos i am glad to read so many negative comments about the xxmaj tritter plot . xxmaj everyone i talk to says the same thing . xxmaj they like xxmaj house 's gruff nature and his intelligence , but really dislike the vindictiveness of this xxunk plot . xxmaj it cuts into the real nature of the hospital story and makes everyone angry at police authority . xxmaj it needs to have</td>
<td>i am glad to read so many negative comments about the xxmaj tritter plot . xxmaj everyone i talk to says the same thing . xxmaj they like xxmaj house 's gruff nature and his intelligence , but really dislike the vindictiveness of this xxunk plot . xxmaj it cuts into the real nature of the hospital story and makes everyone angry at police authority . xxmaj it needs to have a</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>village xxunk her . \n\n▁ xxmaj yeah it does n't sound as a original as xxmaj nurse xxmaj xxunk , but that 's not the point . xxmaj it is really to bring to life an interesting idea of a world of two enemies : xxmaj fire &amp; xxmaj ice . xxmaj and it succeeds . \n\n▁ xxmaj as for the action scenes : superb . xxmaj they are well handled ,</td>
<td>xxunk her . \n\n▁ xxmaj yeah it does n't sound as a original as xxmaj nurse xxmaj xxunk , but that 's not the point . xxmaj it is really to bring to life an interesting idea of a world of two enemies : xxmaj fire &amp; xxmaj ice . xxmaj and it succeeds . \n\n▁ xxmaj as for the action scenes : superb . xxmaj they are well handled , have</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>killed instantly , but it would seem that they are in fact the lucky ones . xxmaj steve returns to xxmaj earth a constantly xxunk mass of xxunk pulp ; as he turns into a savage killer , melting every step of the way , he is xxunk by his friend , xxmaj dr . xxmaj xxunk xxmaj nelson ( burr debenning ) . \n\n xxmaj this is often so xxunk funny</td>
<td>instantly , but it would seem that they are in fact the lucky ones . xxmaj steve returns to xxmaj earth a constantly xxunk mass of xxunk pulp ; as he turns into a savage killer , melting every step of the way , he is xxunk by his friend , xxmaj dr . xxmaj xxunk xxmaj nelson ( burr debenning ) . \n\n xxmaj this is often so xxunk funny -</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>was more writing - better writing , much better writing - and less gratuitous sexual imagery we might have something to work with . \n\n xxmaj this movie should have been shot , made and xxunk a hardcore porn movie all along ; it would have made more money . xxmaj it practically is a hardcore porn film already , and it remains the only non - porn movie xxmaj i 've</td>
<td>more writing - better writing , much better writing - and less gratuitous sexual imagery we might have something to work with . \n\n xxmaj this movie should have been shot , made and xxunk a hardcore porn movie all along ; it would have made more money . xxmaj it practically is a hardcore porn film already , and it remains the only non - porn movie xxmaj i 've seen</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>xxmaj times " . xxmaj they were exactly the same characters but with different xxunk xxmaj sam xxmaj foster was the xxmaj dad , his wife was xxmaj pearl xxmaj foster and the three children were xxmaj xxunk ( a young xxmaj xxunk xxmaj henry ) , xxmaj shirley and xxmaj benjamin . xxmaj pearl 's xxunk friend was xxmaj xxunk . ( to read about xxmaj the xxmaj fosters , i</td>
<td>times " . xxmaj they were exactly the same characters but with different xxunk xxmaj sam xxmaj foster was the xxmaj dad , his wife was xxmaj pearl xxmaj foster and the three children were xxmaj xxunk ( a young xxmaj xxunk xxmaj henry ) , xxmaj shirley and xxmaj benjamin . xxmaj pearl 's xxunk friend was xxmaj xxunk . ( to read about xxmaj the xxmaj fosters , i have</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>so , though the movie says it is all about letting someone else , other than xxmaj allen , get the girl , she does n't get anyone . xxmaj jackman , the man she 's been making love to , is a man who murdered a prostitute . xxmaj nice , xxmaj woody . xxmaj nice way to xxunk your heroine for being beyond your grasp . \n\n xxmaj in a</td>
<td>, though the movie says it is all about letting someone else , other than xxmaj allen , get the girl , she does n't get anyone . xxmaj jackman , the man she 's been making love to , is a man who murdered a prostitute . xxmaj nice , xxmaj woody . xxmaj nice way to xxunk your heroine for being beyond your grasp . \n\n xxmaj in a xxunk</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>i only rented . i suppose the real fans of this film would probably have to be sadistic and xxmaj gothic to care about it without taking in any xxup cgi or any other effects for that matter , i hope xxmaj alex xxmaj xxunk learnt a lesson about lighting and xxup xxunk to make a better film in the future , that is , if he is still in work .</td>
<td>only rented . i suppose the real fans of this film would probably have to be sadistic and xxmaj gothic to care about it without taking in any xxup cgi or any other effects for that matter , i hope xxmaj alex xxmaj xxunk learnt a lesson about lighting and xxup xxunk to make a better film in the future , that is , if he is still in work . \n\n</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>feel better when it 's finished . xxbos xxmaj this movie had good intentions and a good story to work with . xxmaj the director and screenwriter of this movie failed miserably and created a dull , boring xxunk that made me feel like i was back in xxmaj mr . xxmaj xxunk 's 8th grade xxmaj social xxmaj studies class -- way back in xxunk . \n\n xxmaj what a waste</td>
<td>better when it 's finished . xxbos xxmaj this movie had good intentions and a good story to work with . xxmaj the director and screenwriter of this movie failed miserably and created a dull , boring xxunk that made me feel like i was back in xxmaj mr . xxmaj xxunk 's 8th grade xxmaj social xxmaj studies class -- way back in xxunk . \n\n xxmaj what a waste ,</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>william xxmaj xxunk as the villain xxmaj xxunk xxmaj xxunk , and xxmaj xxunk xxmaj xxunk as m ( forgive me all if i spell it wrong ) . xxmaj this game would be own as the greatest xxmaj james xxmaj bond game around . \n\n i give this a 10 / 10 xxbos xxup tv does influence society … just look at the xxunk in popularity of xxunk shops after this</td>
<td>xxmaj xxunk as the villain xxmaj xxunk xxmaj xxunk , and xxmaj xxunk xxmaj xxunk as m ( forgive me all if i spell it wrong ) . xxmaj this game would be own as the greatest xxmaj james xxmaj bond game around . \n\n i give this a 10 / 10 xxbos xxup tv does influence society … just look at the xxunk in popularity of xxunk shops after this shallow</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="todo-walk-through-the-ulmfit-approach-to-training-a-language-model-building-up-the-dataloaders-with-the-datablock-api." class="level1">
<h1>TODO, walk through the ULMFit approach to training a language model, building up the dataloaders with the DataBlock API.</h1>
</section>
<section id="todo-walk-through-the-tabular-data-example" class="level1">
<h1>TODO, walk through the tabular data example</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/gkteco\.github\.io\/blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/gkteco/blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>